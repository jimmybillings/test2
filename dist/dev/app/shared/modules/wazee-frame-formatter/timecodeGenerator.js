"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
var timecodeFormat_1 = require("./timecodeFormat");
var time_1 = require("./time");
exports.DEFAULT_TIME_CODE_LENGTH = 'hh:mm:ss:ff'.length;
var TimecodeGenerator = (function () {
    function TimecodeGenerator(framesPerSecond) {
        this.framesPerSecond = framesPerSecond;
        this.time = new time_1.Time(this.framesPerSecond);
        var integralFramesPerSecond = Math.round(this.framesPerSecond);
        this.accurateFramesPerSecond =
            this.framesPerSecond === integralFramesPerSecond ? this.framesPerSecond : integralFramesPerSecond * 1000 / 1001;
    }
    TimecodeGenerator.extraFramesNeededForDropFrame = function (framesPerSecond, time) {
        switch (framesPerSecond) {
            case 29.97: return TimecodeGenerator.extraFramesNeededFor2997DropFrame(time);
            case 59.94: return TimecodeGenerator.extraFramesNeededFor5994DropFrame(time);
            case 23.976: return TimecodeGenerator.extraFramesNeededFor23976DropFrame(time);
            default: return 0;
        }
    };
    TimecodeGenerator.extraFramesNeededFor2997DropFrame = function (time) {
        var minutes = time.minutes;
        var minutesTensDigit = Math.floor(minutes / 10);
        var minutesOnesDigit = minutes % 10;
        return (time.hours * 108) + (minutesTensDigit * 18) + (minutesOnesDigit * 2);
    };
    TimecodeGenerator.extraFramesNeededFor5994DropFrame = function (time) {
        return TimecodeGenerator.extraFramesNeededFor2997DropFrame(time) * 2;
    };
    TimecodeGenerator.extraFramesNeededFor23976DropFrame = function (time) {
        var hours = time.hours;
        var minutes = time.minutes;
        var extra = hours * 60;
        extra += (Math.floor((hours + 1) / 3) + Math.floor(hours / 3)) * 26;
        extra += minutes;
        if (!time.hoursMultipleOf(3)) {
            extra += Math.floor(minutes * 0.5);
            [16, 30, 44].forEach(function (specialMinute) { if (minutes >= specialMinute)
                extra -= 1; });
        }
        return extra;
    };
    TimecodeGenerator.prototype.setFromFrameNumber = function (frameNumber) {
        this.frameNumber = frameNumber;
        return this;
    };
    TimecodeGenerator.prototype.asString = function (format, minLength) {
        if (minLength === void 0) { minLength = exports.DEFAULT_TIME_CODE_LENGTH; }
        var frameDelimiter = ':';
        this.time.clear();
        switch (format) {
            case timecodeFormat_1.TimecodeFormat.NONDROPFRAME:
                this.time.frames = this.frameNumber;
                break;
            case timecodeFormat_1.TimecodeFormat.DROPFRAME:
                this.time.frames = this.frameNumber;
                this.addDropFramesIfNecessary();
                frameDelimiter = ';';
                break;
            case timecodeFormat_1.TimecodeFormat.SIMPLE_TIME_CONVERSION:
            case timecodeFormat_1.TimecodeFormat.MINIMAL_TIME_CONVERSION:
                var rawSeconds = this.frameNumber / this.accurateFramesPerSecond;
                var truncatedSeconds = Math.floor(rawSeconds);
                this.time.seconds = truncatedSeconds;
                this.time.frames = Math.round((rawSeconds - truncatedSeconds) * this.framesPerSecond);
                ;
                frameDelimiter = ';';
        }
        return format === timecodeFormat_1.TimecodeFormat.MINIMAL_TIME_CONVERSION
            ? this.minimallyFormatTime()
            : this.formatTime(minLength, frameDelimiter);
    };
    TimecodeGenerator.prototype.addDropFramesIfNecessary = function () {
        var originalHours = this.time.hours;
        var originalMinutes = this.time.minutes;
        var extraFrames = TimecodeGenerator.extraFramesNeededForDropFrame(this.framesPerSecond, this.time);
        if (extraFrames <= 0)
            return null;
        this.time.addFrames(extraFrames);
        var newHours = this.time.hours;
        var newMinutes = this.time.minutes;
        switch (this.framesPerSecond) {
            case 29.97:
                if (newMinutes > originalMinutes && !this.time.minutesMultipleOf(10))
                    this.time.addFrames(2);
                break;
            case 59.94:
                if (newMinutes > originalMinutes && !this.time.minutesMultipleOf(10))
                    this.time.addFrames(4);
                break;
            case 23.976:
                var extraExtraFrames = 0;
                if (newMinutes > originalMinutes) {
                    extraExtraFrames += newMinutes - originalMinutes;
                    if (!this.time.hoursMultipleOf(3) && this.time.minutesMultipleOf(2) && !this.time.minutesOneOf(0, 16, 30, 44)) {
                        extraExtraFrames += 1;
                    }
                }
                if (newHours > originalHours) {
                    extraExtraFrames += 1;
                }
                this.time.addFrames(extraExtraFrames);
        }
    };
    TimecodeGenerator.prototype.formatTime = function (minLength, frameDelimiter) {
        if (frameDelimiter === void 0) { frameDelimiter = ':'; }
        var timecode = [
            this.time.hours,
            ':',
            this.zeroFillTo(2, this.time.minutes),
            ':',
            this.zeroFillTo(2, this.time.seconds),
            frameDelimiter,
            this.zeroFillTo(2, this.time.frames)
        ].join('');
        return this.zeroFillTo(minLength, timecode);
    };
    TimecodeGenerator.prototype.minimallyFormatTime = function () {
        var _a = this.time, hours = _a.hours, minutes = _a.minutes, seconds = _a.seconds, frames = _a.frames;
        var outputPieces = [this.zeroFillTo(2, seconds)];
        if (minutes > 0)
            outputPieces.unshift(this.zeroFillTo(2, minutes) + ':');
        if (hours > 0)
            outputPieces.unshift(this.zeroFillTo(2, hours) + ':');
        if (frames > 0)
            outputPieces.push(';' + this.zeroFillTo(2, frames));
        return outputPieces.join('');
    };
    TimecodeGenerator.prototype.zeroFillTo = function (minNumberOfDigits, input) {
        var output = String(input);
        while (output.length < minNumberOfDigits) {
            output = "0" + output;
        }
        return output;
    };
    return TimecodeGenerator;
}());
exports.TimecodeGenerator = TimecodeGenerator;

//# sourceMappingURL=data:application/json;charset=utf8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImFwcC9zaGFyZWQvbW9kdWxlcy93YXplZS1mcmFtZS1mb3JtYXR0ZXIvdGltZWNvZGVHZW5lcmF0b3IudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFBQSxtREFBa0Q7QUFDbEQsK0JBQThCO0FBRWpCLFFBQUEsd0JBQXdCLEdBQUcsYUFBYSxDQUFDLE1BQU0sQ0FBQztBQUU3RDtJQWlERSwyQkFBWSxlQUF1QjtRQUNqQyxJQUFJLENBQUMsZUFBZSxHQUFHLGVBQWUsQ0FBQztRQUN2QyxJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksV0FBSSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztRQUUzQyxJQUFNLHVCQUF1QixHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBQ2pFLElBQUksQ0FBQyx1QkFBdUI7WUFDMUIsSUFBSSxDQUFDLGVBQWUsS0FBSyx1QkFBdUIsQ0FBQyxDQUFDLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDLENBQUMsdUJBQXVCLEdBQUcsSUFBSSxHQUFHLElBQUksQ0FBQztJQUNwSCxDQUFDO0lBL0NhLCtDQUE2QixHQUEzQyxVQUE0QyxlQUF1QixFQUFFLElBQVU7UUFDN0UsTUFBTSxDQUFDLENBQUMsZUFBZSxDQUFDLENBQUMsQ0FBQztZQUN4QixLQUFLLEtBQUssRUFBRSxNQUFNLENBQUMsaUJBQWlCLENBQUMsaUNBQWlDLENBQUMsSUFBSSxDQUFDLENBQUM7WUFDN0UsS0FBSyxLQUFLLEVBQUUsTUFBTSxDQUFDLGlCQUFpQixDQUFDLGlDQUFpQyxDQUFDLElBQUksQ0FBQyxDQUFDO1lBQzdFLEtBQUssTUFBTSxFQUFFLE1BQU0sQ0FBQyxpQkFBaUIsQ0FBQyxrQ0FBa0MsQ0FBQyxJQUFJLENBQUMsQ0FBQztZQUMvRSxTQUFTLE1BQU0sQ0FBQyxDQUFDLENBQUM7UUFDcEIsQ0FBQztJQUNILENBQUM7SUFFYSxtREFBaUMsR0FBL0MsVUFBZ0QsSUFBVTtRQUN4RCxJ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Q0FBQyxDQUFDLENBQUM7UUFFcEUsTUFBTSxDQUFDLFlBQVksQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLENBQUM7SUFDL0IsQ0FBQztJQUVPLHNDQUFVLEdBQWxCLFVBQW1CLGlCQUF5QixFQUFFLEtBQXNCO1FBQ2xFLElBQUksTUFBTSxHQUFXLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUVuQyxPQUFPLE1BQU0sQ0FBQyxNQUFNLEdBQUcsaUJBQWlCLEVBQUUsQ0FBQztZQUN6QyxNQUFNLEdBQUcsTUFBSSxNQUFRLENBQUM7UUFDeEIsQ0FBQztRQUVELE1BQU0sQ0FBQyxNQUFNLENBQUM7SUFDaEIsQ0FBQztJQUNILHdCQUFDO0FBQUQsQ0F4S0EsQUF3S0MsSUFBQTtBQXhLWSw4Q0FBaUIiLCJmaWxlIjoiYXBwL3NoYXJlZC9tb2R1bGVzL3dhemVlLWZyYW1lLWZvcm1hdHRlci90aW1lY29kZUdlbmVyYXRvci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IFRpbWVjb2RlRm9ybWF0IH0gZnJvbSAnLi90aW1lY29kZUZvcm1hdCc7XG5pbXBvcnQgeyBUaW1lIH0gZnJvbSAnLi90aW1lJztcblxuZXhwb3J0IGNvbnN0IERFRkFVTFRfVElNRV9DT0RFX0xFTkdUSCA9ICdoaDptbTpzczpmZicubGVuZ3RoO1xuXG5leHBvcnQgY2xhc3MgVGltZWNvZGVHZW5lcmF0b3Ige1xuICBwdWJsaWMgZnJhbWVzUGVyU2Vjb25kOiBudW1iZXI7XG4gIHB1YmxpYyBhY2N1cmF0ZUZyYW1lc1BlclNlY29uZDogbnVtYmVyO1xuICBwdWJsaWMgZnJhbWVOdW1iZXI6IG51bWJlcjtcblxuICBwcml2YXRlIHRpbWU6IFRpbWU7XG5cbiAgLy8gLS0tLS0tLSBTVEFUSUMgKENMQVNTKSBNRVRIT0RTIC0tLS0tLS1cblxuICBwdWJsaWMgc3RhdGljIGV4dHJhRnJhbWVzTmVlZGVkRm9yRHJvcEZyYW1lKGZyYW1lc1BlclNlY29uZDogbnVtYmVyLCB0aW1lOiBUaW1lKTogbnVtYmVyIHtcbiAgICBzd2l0Y2ggKGZyYW1lc1BlclNlY29uZCkge1xuICAgICAgY2FzZSAyOS45NzogcmV0dXJuIFRpbWVjb2RlR2VuZXJhdG9yLmV4dHJhRnJhbWVzTmVlZGVkRm9yMjk5N0Ryb3BGcmFtZSh0aW1lKTtcbiAgICAgIGNhc2UgNTkuOTQ6IHJldHVybiBUaW1lY29kZUdlbmVyYXRvci5leHRyYUZyYW1lc05lZWRlZEZvcjU5OTREcm9wRnJhbWUodGltZSk7XG4gICAgICBjYXNlIDIzLjk3NjogcmV0dXJuIFRpbWVjb2RlR2VuZXJhdG9yLmV4dHJhRnJhbWVzTmVlZGVkRm9yMjM5NzZEcm9wRnJhbWUodGltZSk7XG4gICAgICBkZWZhdWx0OiByZXR1cm4gMDtcbiAgICB9XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGV4dHJhRnJhbWVzTmVlZGVkRm9yMjk5N0Ryb3BGcmFtZSh0aW1lOiBUaW1lKTogbnVtYmVyIHtcbiAgICBjb25zdCBtaW51dGVzID0gdGltZS5taW51dGVzO1xuICAgIGNvbnN0IG1pbnV0ZXNUZW5zRGlnaXQgPSBNYXRoLmZsb29yKG1pbnV0ZXMgLyAxMCk7XG4gICAgY29uc3QgbWludXRlc09uZXNEaWdpdCA9IG1pbnV0ZXMgJSAxMDtcblxuICAgIHJldHVybiAodGltZS5ob3VycyAqIDEwOCkgKyAobWludXRlc1RlbnNEaWdpdCAqIDE4KSArIChtaW51dGVzT25lc0RpZ2l0ICogMik7XG4gIH1cblxuICBwdWJsaWMgc3RhdGljIGV4dHJhRnJhbWVzTmVlZGVkRm9yNTk5NERyb3BGcmFtZSh0aW1lOiBUaW1lKTogbnVtYmVyIHtcbiAgICByZXR1cm4gVGltZWNvZGVHZW5lcmF0b3IuZXh0cmFGcmFtZXNOZWVkZWRGb3IyOTk3RHJvcEZyYW1lKHRpbWUpICogMjtcbiAgfVxuXG4gIHB1YmxpYyBzdGF0aWMgZXh0cmFGcmFtZXNOZWVkZWRGb3IyMzk3NkRyb3BGcmFtZSh0aW1lOiBUaW1lKTogbnVtYmVyIHtcbiAgICBjb25zdCBob3VycyA9IHRpbWUuaG91cnM7XG4gICAgY29uc3QgbWludXRlcyA9IHRpbWUubWludXRlcztcblxuICAgIGxldCBleHRyYSA9IGhvdXJzICogNjA7XG4gICAgZXh0cmEgKz0gKE1hdGguZmxvb3IoKGhvdXJzICsgMSkgLyAzKSArIE1hdGguZmxvb3IoaG91cnMgLyAzKSkgKiAyNjtcbiAgICBleHRyYSArPSBtaW51dGVzO1xuXG4gICAgaWYgKCF0aW1lLmhvdXJzTXVsdGlwbGVPZigzKSkge1xuICAgICAgZXh0cmEgKz0gTWF0aC5mbG9vcihtaW51dGVzICogMC41KTtcblxuICAgICAgWzE2LCAzMCwgNDRdLmZvckVhY2goc3BlY2lhbE1pbnV0ZSA9PiB7IGlmIChtaW51dGVzID49IHNwZWNpYWxNaW51dGUpIGV4dHJhIC09IDE7IH0pO1xuICAgIH1cblxuICAgIHJldHVybiBleHRyYTtcbiAgfVxuXG4gIC8vIC0tLS0tLS0gUFVCTElDIElOVEVSRkFDRSAtLS0tLS0tXG5cbiAgY29uc3RydWN0b3IoZnJhbWVzUGVyU2Vjb25kOiBudW1iZXIpIHtcbiAgICB0aGlzLmZyYW1lc1BlclNlY29uZCA9IGZyYW1lc1BlclNlY29uZDtcbiAgICB0aGlzLnRpbWUgPSBuZXcgVGltZSh0aGlzLmZyYW1lc1BlclNlY29uZCk7XG5cbiAgICBjb25zdCBpbnRlZ3JhbEZyYW1lc1BlclNlY29uZCA9IE1hdGgucm91bmQodGhpcy5mcmFtZXNQZXJTZWNvbmQpO1xuICAgIHRoaXMuYWNjdXJhdGVGcmFtZXNQZXJTZWNvbmQgPVxuICAgICAgdGhpcy5mcmFtZXNQZXJTZWNvbmQgPT09IGludGVncmFsRnJhbWVzUGVyU2Vjb25kID8gdGhpcy5mcmFtZXNQZXJTZWNvbmQgOiBpbnRlZ3JhbEZyYW1lc1BlclNlY29uZCAqIDEwMDAgLyAxMDAxO1xuICB9XG5cbiAgcHVibGljIHNldEZyb21GcmFtZU51bWJlcihmcmFtZU51bWJlcjogbnVtYmVyKTogVGltZWNvZGVHZW5lcmF0b3Ige1xuICAgIHRoaXMuZnJhbWVOdW1iZXIgPSBmcmFtZU51bWJlcjtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIHB1YmxpYyBhc1N0cmluZyhmb3JtYXQ6IFRpbWVjb2RlRm9ybWF0LCBtaW5MZW5ndGg6IG51bWJlciA9IERFRkFVTFRfVElNRV9DT0RFX0xFTkdUSCk6IHN0cmluZyB7XG4gICAgbGV0IGZyYW1lRGVsaW1pdGVyID0gJzonO1xuICAgIHRoaXMudGltZS5jbGVhcigpO1xuXG4gICAgc3dpdGNoIChmb3JtYXQpIHtcbiAgICAgIGNhc2UgVGltZWNvZGVGb3JtYXQuTk9ORFJPUEZSQU1FOlxuICAgICAgICB0aGlzLnRpbWUuZnJhbWVzID0gdGhpcy5mcmFtZU51bWJlcjtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgVGltZWNvZGVGb3JtYXQuRFJPUEZSQU1FOlxuICAgICAgICB0aGlzLnRpbWUuZnJhbWVzID0gdGhpcy5mcmFtZU51bWJlcjtcbiAgICAgICAgdGhpcy5hZGREcm9wRnJhbWVzSWZOZWNlc3NhcnkoKTtcbiAgICAgICAgZnJhbWVEZWxpbWl0ZXIgPSAnOyc7XG4gICAgICAgIGJyZWFrO1xuXG4gICAgICBjYXNlIFRpbWVjb2RlRm9ybWF0LlNJTVBMRV9USU1FX0NPTlZFUlNJT046XG4gICAgICBjYXNlIFRpbWVjb2RlRm9ybWF0Lk1JTklNQUxfVElNRV9DT05WRVJTSU9OOlxuICAgICAgICBjb25zdCByYXdTZWNvbmRzID0gdGhpcy5mcmFtZU51bWJlciAvIHRoaXMuYWNjdXJhdGVGcmFtZXNQZXJTZWNvbmQ7XG4gICAgICAgIGNvbnN0IHRydW5jYXRlZFNlY29uZHMgPSBNYXRoLmZsb29yKHJhd1NlY29uZHMpO1xuXG4gICAgICAgIHRoaXMudGltZS5zZWNvbmRzID0gdHJ1bmNhdGVkU2Vjb25kcztcbiAgICAgICAgdGhpcy50aW1lLmZyYW1lcyA9IE1hdGgucm91bmQoKHJhd1NlY29uZHMgLSB0cnVuY2F0ZWRTZWNvbmRzKSAqIHRoaXMuZnJhbWVzUGVyU2Vjb25kKTs7XG4gICAgICAgIGZyYW1lRGVsaW1pdGVyID0gJzsnO1xuICAgIH1cblxuICAgIHJldHVybiBmb3JtYXQgPT09IFRpbWVjb2RlRm9ybWF0Lk1JTklNQUxfVElNRV9DT05WRVJTSU9OXG4gICAgICA/IHRoaXMubWluaW1hbGx5Rm9ybWF0VGltZSgpXG4gICAgICA6IHRoaXMuZm9ybWF0VGltZShtaW5MZW5ndGgsIGZyYW1lRGVsaW1pdGVyKTtcbiAgfVxuXG4gIC8vIC0tLS0tLS0gUFJJVkFURSBNRVRIT0RTIC0tLS0tLS1cblxuICBwcml2YXRlIGFkZERyb3BGcmFtZXNJZk5lY2Vzc2FyeSgpOiB2b2lkIHtcbiAgICBjb25zdCBvcmlnaW5hbEhvdXJzOiBudW1iZXIgPSB0aGlzLnRpbWUuaG91cnM7XG4gICAgY29uc3Qgb3JpZ2luYWxNaW51dGVzOiBudW1iZXIgPSB0aGlzLnRpbWUubWludXRlcztcbiAgICBjb25zdCBleHRyYUZyYW1lczogbnVtYmVyID0gVGltZWNvZGVHZW5lcmF0b3IuZXh0cmFGcmFtZXNOZWVkZWRGb3JEcm9wRnJhbWUodGhpcy5mcmFtZXNQZXJTZWNvbmQsIHRoaXMudGltZSk7XG5cbiAgICBpZiAoZXh0cmFGcmFtZXMgPD0gMCkgcmV0dXJuIG51bGw7XG5cbiAgICB0aGlzLnRpbWUuYWRkRnJhbWVzKGV4dHJhRnJhbWVzKTtcbiAgICBjb25zdCBuZXdIb3VycyA9IHRoaXMudGltZS5ob3VycztcbiAgICBjb25zdCBuZXdNaW51dGVzID0gdGhpcy50aW1lLm1pbnV0ZXM7XG5cbiAgICBzd2l0Y2ggKHRoaXMuZnJhbWVzUGVyU2Vjb25kKSB7XG4gICAgICBjYXNlIDI5Ljk3OlxuICAgICAgICBpZiAobmV3TWludXRlcyA+IG9yaWdpbmFsTWludXRlcyAmJiAhdGhpcy50aW1lLm1pbnV0ZXNNdWx0aXBsZU9mKDEwKSkgdGhpcy50aW1lLmFkZEZyYW1lcygyKTtcbiAgICAgICAgYnJlYWs7XG5cbiAgICAgIGNhc2UgNTkuOTQ6XG4gICAgICAgIGlmIChuZXdNaW51dGVzID4gb3JpZ2luYWxNaW51dGVzICYmICF0aGlzLnRpbWUubWludXRlc011bHRpcGxlT2YoMTApKSB0aGlzLnRpbWUuYWRkRnJhbWVzKDQpO1xuICAgICAgICBicmVhaztcblxuICAgICAgY2FzZSAyMy45NzY6XG4gICAgICAgIGxldCBleHRyYUV4dHJhRnJhbWVzID0gMDtcblxuICAgICAgICBpZiAobmV3TWludXRlcyA+IG9yaWdpbmFsTWludXRlcykge1xuICAgICAgICAgIGV4dHJhRXh0cmFGcmFtZXMgKz0gbmV3TWludXRlcyAtIG9yaWdpbmFsTWludXRlcztcbiAgICAgICAgICBpZiAoIXRoaXMudGltZS5ob3Vyc011bHRpcGxlT2YoMykgJiYgdGhpcy50aW1lLm1pbnV0ZXNNdWx0aXBsZU9mKDIpICYmICF0aGlzLnRpbWUubWludXRlc09uZU9mKDAsIDE2LCAzMCwgNDQpKSB7XG4gICAgICAgICAgICBleHRyYUV4dHJhRnJhbWVzICs9IDE7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKG5ld0hvdXJzID4gb3JpZ2luYWxIb3Vycykge1xuICAgICAgICAgIGV4dHJhRXh0cmFGcmFtZXMgKz0gMTtcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMudGltZS5hZGRGcmFtZXMoZXh0cmFFeHRyYUZyYW1lcyk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBmb3JtYXRUaW1lKG1pbkxlbmd0aDogbnVtYmVyLCBmcmFtZURlbGltaXRlcjogc3RyaW5nID0gJzonKTogc3RyaW5nIHtcbiAgICBjb25zdCB0aW1lY29kZTogc3RyaW5nID1cbiAgICAgIFtcbiAgICAgICAgdGhpcy50aW1lLmhvdXJzLFxuICAgICAgICAnOicsXG4gICAgICAgIHRoaXMuemVyb0ZpbGxUbygyLCB0aGlzLnRpbWUubWludXRlcyksXG4gICAgICAgICc6JyxcbiAgICAgICAgdGhpcy56ZXJvRmlsbFRvKDIsIHRoaXMudGltZS5zZWNvbmRzKSxcbiAgICAgICAgZnJhbWVEZWxpbWl0ZXIsXG4gICAgICAgIHRoaXMuemVyb0ZpbGxUbygyLCB0aGlzLnRpbWUuZnJhbWVzKVxuICAgICAgXS5qb2luKCcnKTtcblxuICAgIHJldHVybiB0aGlzLnplcm9GaWxsVG8obWluTGVuZ3RoLCB0aW1lY29kZSk7XG4gIH1cblxuICBwcml2YXRlIG1pbmltYWxseUZvcm1hdFRpbWUoKTogc3RyaW5nIHtcbiAgICBjb25zdCB7IGhvdXJzLCBtaW51dGVzLCBzZWNvbmRzLCBmcmFtZXMgfSA9IHRoaXMudGltZTtcblxuICAgIGxldCBvdXRwdXRQaWVjZXM6IHN0cmluZ1tdID0gW3RoaXMuemVyb0ZpbGxUbygyLCBzZWNvbmRzKV07XG4gICAgaWYgKG1pbnV0ZXMgPiAwKSBvdXRwdXRQaWVjZXMudW5zaGlmdCh0aGlzLnplcm9GaWxsVG8oMiwgbWludXRlcykgKyAnOicpO1xuICAgIGlmIChob3VycyA+IDApIG91dHB1dFBpZWNlcy51bnNoaWZ0KHRoaXMuemVyb0ZpbGxUbygyLCBob3VycykgKyAnOicpO1xuICAgIGlmIChmcmFtZXMgPiAwKSBvdXRwdXRQaWVjZXMucHVzaCgnOycgKyB0aGlzLnplcm9GaWxsVG8oMiwgZnJhbWVzKSk7XG5cbiAgICByZXR1cm4gb3V0cHV0UGllY2VzLmpvaW4oJycpO1xuICB9XG5cbiAgcHJpdmF0ZSB6ZXJvRmlsbFRvKG1pbk51bWJlck9mRGlnaXRzOiBudW1iZXIsIGlucHV0OiBudW1iZXIgfCBzdHJpbmcpOiBzdHJpbmcge1xuICAgIGxldCBvdXRwdXQ6IHN0cmluZyA9IFN0cmluZyhpbnB1dCk7XG5cbiAgICB3aGlsZSAob3V0cHV0Lmxlbmd0aCA8IG1pbk51bWJlck9mRGlnaXRzKSB7XG4gICAgICBvdXRwdXQgPSBgMCR7b3V0cHV0fWA7XG4gICAgfVxuXG4gICAgcmV0dXJuIG91dHB1dDtcbiAgfVxufVxuIl19
